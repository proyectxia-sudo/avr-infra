services:
  # El servicio Traefik se ha eliminado porque Dokploy ya lo gestiona.
  avr-app-backend:
    image: agentvoiceresponse/avr-app-backend
    platform: linux/x86_64
    container_name: avr-app-backend
    restart: always
    environment:
      - PORT=3001
      - JWT_SECRET=${JWT_SECRET:-cambia-esto-por-una-clave-secreta-larga}
      - FRONTEND_URL=http://avr.31.97.118.226.traefik.me
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      - WEBHOOK_URL=http://avr-app-backend:3001/webhooks
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-cambia-esto-por-otro-secreto}
      - ARI_URL=http://avr-asterisk:8088/ari
      - ARI_USERNAME=${ARI_USERNAME:-avr}
      - ARI_PASSWORD=${ARI_PASSWORD:-avr}
      - TENANT=${TENANT:-demo}
      - CORE_DEFAULT_IMAGE=agentvoiceresponse/avr-core
      - DB_TYPE=sqlite
      - DB_DATABASE=/app/data/data.db
      - ASTERISK_CONFIG_PATH=/app/asterisk
      - ASTERISK_RECORDINGS_PATH=/app/recordings
    labels:
      - traefik.enable=true
      - traefik.http.routers.avr-app-backend.rule=Host(`avr-api.31.97.118.226.traefik.me`)
      - traefik.http.routers.avr-app-backend.entrypoints=web
      - traefik.http.services.avr-app-backend.loadbalancer.server.port=3001
      - traefik.docker.network=dokploy-network
    volumes:
      - ./asterisk/conf:/app/asterisk
      - ./data:/app/data
      - ./asterisk/recordings:/app/recordings
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - avr
      - dokploy-network
  avr-app-frontend:
    image: agentvoiceresponse/avr-app-frontend
    platform: linux/x86_64
    container_name: avr-app-frontend
    restart: always
    environment:
      - NEXT_PUBLIC_API_URL=http://avr-api.31.97.118.226.traefik.me
      - NEXT_PUBLIC_WEBRTC_CLIENT_URL=https://phone.agentvoiceresponse.com/index.html
    labels:
      - traefik.enable=true
      - traefik.http.routers.avr-app-frontend.rule=Host(`avr.31.97.118.226.traefik.me`)
      - traefik.http.routers.avr-app-frontend.entrypoints=web
      - traefik.http.services.avr-app-frontend.loadbalancer.server.port=3000
      - traefik.docker.network=dokploy-network
    networks:
      - avr
      - dokploy-network
  avr-asterisk:
    image: agentvoiceresponse/avr-asterisk
    platform: linux/x86_64
    container_name: avr-asterisk
    restart: always
    ports:
      - 8089:8089
      - 10000-10050:10000-10050/udp
    volumes:
      - ./asterisk/conf/manager.conf:/etc/asterisk/my_manager.conf
      - ./asterisk/conf/pjsip.conf:/etc/asterisk/my_pjsip.conf
      - ./asterisk/conf/extensions.conf:/etc/asterisk/my_extensions.conf
      - ./asterisk/conf/queues.conf:/etc/asterisk/my_queues.conf
      - ./asterisk/conf/ari.conf:/etc/asterisk/my_ari.conf
      - ./asterisk/recordings:/var/spool/asterisk/monitor
    networks:
      - avr
      - dokploy-network
# --- AQUÍ ESTÁ EL CAMBIO ---
networks:
  avr:
    name: avr
    driver: bridge
    # Eliminamos la sección 'ipam' y 'config' para que Docker elija una IP libre automáticamente
  dokploy-network:
    external: true
